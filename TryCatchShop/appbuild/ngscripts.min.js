"use strict";window.app=angular.module("TryCatchShop",["ngRoute","ngResource","ui.bootstrap","ngAnimate","toaster","chieffancypants.loadingBar","ngMap","LocalStorageModule","angularFileUpload"]),app.config(["$routeProvider","$locationProvider",function(e,t){e.when("/",{controller:"IndexController",templateUrl:"/appbuild/views/home.html"}),e.when("/admin/",{controller:"AdminController",templateUrl:"/appbuild/views/admin.html"}),e.when("/login/",{controller:"LoginController",templateUrl:"/appbuild/views/home.html"}),e.otherwise({redirectTo:"/"}),t.html5Mode(!0)}]),app.config(function(e){e.interceptors.push("authInterceptorService")}),app.run(["authService",function(e){e.fillAuthData()}]),app.constant("enviroment",{apiUrl:"",path:""}),app.animation(".view-slide-in",function(){return{enter:function(e,t){e.css({opacity:.5,position:"relative",top:"0px",left:"200px"}).animate({top:0,left:0,opacity:1},1200,t)}}}),app.controller("AdminController",["$scope","toaster","$modal","authService","$resource","$http","$upload","shopService","enviroment",function(e,t,r,n,o,a,i,u,s){function c(){u.getProducts().$promise.then(function(t){var r=JSLINQ(t).OrderBy(function(e){return e.insertDate}).ToArray();e.products=r})["catch"](function(e){t.error("insert error")})}e.form={},e.products=[],e.uploading=!1,e.savedSuccessfully=!1,e.myFile="",e.path=s.path,e.newProductImage={},e.data={files:"",filesSez:""},e.$watch("data.files",function(e){l(e)});var l=function(t){if(t&&t.length)for(var r=0;r<t.length;r++){var n=t[r];e.uploading=!0,i.upload({url:"api/Product/UploadFile",fields:{username:e.username},file:n}).progress(function(t){var r=parseInt(100*t.loaded/t.total);e.progress=r}).success(function(t,r,n,o){e.newProductImage.FileName=t,e.uploading=!1,e.myFile=t})}};e.submit=function(){e.formPrev.$valid&&(e.form.avaiable=e.form.avaiable===!0?"1":"0",e.form.avaiable=e.form.avaiable===!0?"1":"0",u.addProduct(e.form).then(function(e){t.success("product inserted!")})["catch"](function(e){t.error("error in insert product")}))},c()}]),app.controller("HomeController",["$scope","toaster","$modal","authService","$resource","$http",function(e,t,r,n,o,a){function i(){}e.form={},e.filialeDetails={Filialeid:0,Titolo:"",Indirizzo:"",Cap:"",Telefono:"",Fax:""},i()}]),app.controller("IndexController",["$scope","$location","toaster","$modal","authService","CurrentUser","User","$timeout",function(e,t,r,n,o,a,i,u){function s(){}e.authentication=o.authentication,e.loading=!1,e.message="",e.registration={userName:"",password:"",confirmPassword:"",name:"",surname:"",birthdate:"",address:"",phoneNumber:"",Email:"",Role:"Customer"},e.saveData=function(){o.authentication.isAuth&&c()};var c=function(){e.loading=!0,o.saveRegistration(e.registration).then(function(t){e.savedSuccessfully=!0,e.loading=!1,e.message="User has been registered successfully, you will be redicted to login page in 2 seconds.",l()},function(t){var r=[];for(var n in t.data.modelState)if(n)for(var o=0;o<t.data.modelState[n].length;o++)r.push(t.data.modelState[n][o]);e.message="Failed to register user due to:"+r.join(" ")})};e.openReg=function(){e.$modalInstanceReg=n.open({scope:e,templateUrl:"/appbuild/views/modalSignup.html",size:""})},e.closeReg=function(){e.$modalInstanceReg.close()},e.message="",e.logout=function(){o.logOut().then(function(e){t.path("/home")})},s();var l=function(){var e=u(function(){u.cancel(e),t.path("/login")},2e3)}}]),app.controller("LoginController",["$scope","$location","authService","User","toaster","CurrentUser","$modal",function(e,t,r,n,o,a,i){function u(){e.open()}e.$parent.loading=!1,e.pageClass="page-contact",e.loginData={userName:"",password:""},e.message="",e.open=function(){e.$modalInstance=i.open({scope:e,templateUrl:"/appbuild/views/modalLogin.html",size:""})},e.close=function(){e.$modalInstance.close()},e.login=function(){e.$parent.loading=!0,r.login(e.loginData).then(function(n){r.authentication.isAuth&&e.$modalInstance.close(),e.$parent.loading=!1,t.path("/home")},function(t){e.$parent.loading=!1,e.message=t.error_description,o.error("Username o password errati!")})},u()}]),app.controller("SignupController",["$scope","$location","$timeout","authService","User","toaster",function(e,t,r,n,o,a){function i(){e.format=e.formats[0],e.today(),e.profileStatus.message="Registra il tuo profilo",e.profileStatus.isNew=!0}function u(e){return e.getMonth()+1+"/"+e.getDate()+"/"+e.getFullYear()}e.message="",e.profileStatus={message:"",isNew:!0},e.registration={userName:"",password:"",confirmPassword:"",name:"",surname:"",birthdate:"",address:"",phoneNumber:"",Email:"",Role:"Customer"},e.saveData=function(){n.authentication.isAuth&&c()};var s=function(){var e=r(function(){r.cancel(e),t.path("/login")},2e3)},c=function(){n.saveRegistration(e.registration).then(function(t){e.savedSuccessfully=!0,e.message="User has been registered successfully, you will be redicted to login page in 2 seconds.",s()},function(t){var r=[];for(var n in t.data.modelState)if(n)for(var o=0;o<t.data.modelState[n].length;o++)r.push(t.data.modelState[n][o]);e.message="Failed to register user due to:"+r.join(" ")})};e.formats=["dd.MM.yyyy"],e.today=function(){e.dt=new Date},e.clear=function(){e.dt=null},e.open=function(t){t.preventDefault(),t.stopPropagation(),e.opened=!0},e.dateOptions={formatYear:"yy",startingDay:1},e.$watch("dt",function(){e.registration.birthdate=u(e.dt)}),i()}]),app.directive("picker",function(e){return{restrict:"AE",scope:!0,link:function(t,r,n){var o=window.moment,a=t;e(function(){var e=$(r);e.datepicker({format:"mm/dd/yyyy"}).on("changeDate",function(e){var t=o(e.date).format("DD-MM-YYYY");a.$parent.form.datepicker=t})})}}}),app.directive("fullpage",function(e){return{restrict:"AC",link:function(t,r,n){e(function(){function e(){a.fullpage.destroy()}var n=$(window).width(),o=$(window).height(),a=$(r);$(window).resize(function(){o=$(window).height(),n=$(window).width()}),991>n||680>o?a.on("click","a",function(){a.fullpage.destroy()}):(a.fullpage({menu:"menu"}),a.on("click","a",function(){a.fullpage.destroy()})),t.$on("$destroy",function(){e()})})}}}),app.directive("news",function(e){return{restrict:"AC",link:function(t,r,n){e(function(){var e=$(r);e.easyTicker({speed:"slow",height:"auto"})})}}}),app.directive("ngReallyClick",function(e){return{restrict:"A",link:function(e,t,r){t.bind("click",function(){var t=r.ngReallyMessage;t&&confirm(t)&&e.$apply(r.ngReallyClick)})}}}),app.factory("authService",["$http","$q","localStorageService","toaster","enviroment","CurrentUser",function(e,t,r,n,o,a){var i="",u={isAuth:!1,userName:"",role:""},s=function(){var n=t.defer();try{e.post(o.apiUrl+i+"api/account/Logout").then(function(e){r.remove("authorizationData"),r.remove("currentUser"),a.setCurrentUser(null),u.isAuth=!1,u.userName="",u.role="",n.resolve("logOut")})}catch(s){n.reject(s)}return n.promise};return{saveRegistration:function(t){return s(),e.post(o.apiUrl+i+"api/account/register",t).then(function(e){return e})},login:function(n){var a="grant_type=password&username="+n.userName+"&password="+n.password+"&name="+n.name+"&surname="+n.surname+"&birthdate="+n.birthdate+"&address="+n.address+"&phoneNumber="+n.phoneNumber+"&email="+n.email,c=t.defer();return e.post(o.apiUrl+i+"api/token",a,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){r.set("authorizationData",{token:e.access_token,userName:e.userName,role:e.role}),u.isAuth=!0,u.userName=e.userName,u.role=e.role,c.resolve(e)}).error(function(e,t){s(),c.reject(e)}),c.promise},logOut:s,fillAuthData:function(){var e=r.get("authorizationData");e&&(u.isAuth=!0,u.userName=e.userName,u.role=e.role)},authentication:u}}]),app.factory("authInterceptorService",["$q","$location","localStorageService","toaster",function(e,t,r,n){return{request:function(e){e.headers=e.headers||{};var t=r.get("authorizationData");return t&&(e.headers.Authorization="Bearer "+t.token),e},responseError:function(r){return 401===r.status&&(t.path("/login"),n.options={showDuration:"1200"},n.warning("per accedere alla risorsa bisogna essere autenticati!")),e.reject(r)}}}]),app.factory("CurrentUser",["enviroment",function(e){var t={};return{getCurrentUser:function(){return t},setCurrentUser:function(e){t=e},removeCurrentUser:function(){t={}}}}]),app.factory("shopService",["$resource","$q","localStorageService","toaster","enviroment","CurrentUser",function(e,t,r,n,o,a){var i="api/Product/",u="api/Product/:id",s=e(o.apiUrl+i,{},{query:{method:"GET",isArray:!0}}),c=e(o.apiUrl+u,{id:"@id"},{update:{method:"PUT"},create:{method:"POST"},"delete":{method:"DELETE"}});return{getProduct:function(e){return c.get({id:e})},getProducts:function(){return s.query()},addProduct:function(e){return c.create(e)},deleteProduct:function(e){return c["delete"]({id:e})},updateProduct:function(e,t){return e.firstImage=t,c.update({id:e.id},e)}}}]),app.factory("User",["localStorageService","enviroment","$resource","$q","CurrentUser","$http",function(e,t,r,n,o,a){var i=n.defer(),u="/api/Account/CurrentUser",s="/api/Users/UpdateProfile",c="/api/Users/GetUser/:idOwin",l="/api/Users/",d="/api/Users/:id",p={},f=r(t.apiUrl+l,{},{query:{method:"GET",isArray:!0}}),m=r(t.apiUrl+c,{idOwin:"@idOwin"}),g=r(t.apiUrl+d,{id:"@id"},{update:{method:"PUT"},create:{method:"POST"},"delete":{method:"DELETE"}});return{getCurrentUser:function(){return e.get("currentUser")?(p=e.get("currentUser"),o.setCurrentUser(p),i.resolve(p)):r(t.apiUrl+u).get().$promise.then(function(t){e.set("currentUser",t),o.setCurrentUser(t),p=t,i.resolve(p)})["catch"](function(e){i.reject(e)}),i.promise},updateCurrentUser:function(e){return r(t.apiUrl+s,{},{update:{method:"PUT"}}).update(e)},setCurrentUser:function(t){return e.remove("currentUser"),e.set("currentUser",t),o.setCurrentUser(t),t},getAllUsers:function(){return f.query()},getUser:function(e){return m.get({idOwin:e})},deleteUser:function(e){return g["delete"]({id:e})},updateUser:function(e){return g.update(e)}}}]);